# Bitcoin  Pennybank - Distributed Microtransactions

## Abstract

The architecture of the bitcoin blockchain does not support microtransactions without fees in order to reward the network for maintaining the ledger, small transactions are simply not economically valuable enough to maintain in a distributed blockchain.

This defines a simple technique to turn a larger bitcoin value into miniscule amounts that can be individually transferred between any two parties without requiring trust or timelocks while minimizing the potential for fees and "dust" transactions.  It shows how to create a side-ledger to use for exchanging the microtransactions based on the same proof-of-work mining value of bitcoin itself.

## Motivation

With the rules for accepted P2SH opcodes relaxing [in 0.10](https://github.com/bitcoin/bitcoin/pull/4365), new types of scripts can be used in transactions and will accepted into the blockchain by updated miners.  While many opcodes are still diabled to minimize the risk of a fork, only a `OP_HASH256` is required to enable micro-transactions.

The current [micropayment channels](https://en.bitcoin.it/wiki/Contracts#Example_7:_Rapidly-adjusted_.28micro.29payments_to_a_pre-determined_party) technique works within the current limits and has had some early adoption, but it can now be significantly simplified and aligned with the core value structure of the blockchain, proof-of-work based hashing. The proposed [zero-knowledge contingent payment](https://en.bitcoin.it/wiki/Zero_Knowledge_Contingent_Payment) is also very similar, but instead of an external protocol the contingency function is included as part of the transactions.

## Specification

First, two new script types are defined for use as the individual microtransactions.  These scripts are only valid in a [P2SH](https://en.bitcoin.it/wiki/Pay_to_script_hash) transaction.

### pay-to-hash (P2H)
```
scriptPubKey: OP_HASH256 <checkHash> OP_EQUALVERIFY
scriptSig: <data>
```
This allows anyone with the correct `<data>` to spend it, you may recognize it from the [transaction puzzle example](https://en.bitcoin.it/wiki/Script#Transaction_puzzle).  These types of P2H transactions can now be commonly used to anonymously exchange value based on any secret, as well as the foundation for a proof-of-work when the size of the `<data>` is fixed/known and can be generated by anyone willing to do the hashing work.

### pay-to-hash-hash (P2H2)
```
scriptPubKey: OP_HASH256 <checkHash> OP_EQUALVERIFY OP_DUP OP_HASH160 <pubkeyHash> OP_EQUALVERIFY OP_CHECKSIG
scriptSig: <sig> <pubkey> <data>
```
In order to also lock a P2H to just one recipient, it can be combined with a standard [P2PKH](https://en.bitcoin.it/wiki/Script#Standard_Transaction_to_Bitcoin_address_.28pay-to-pubkey-hash.29), such that both the secret data and a private key are required.

### Penny Bank

A Penny Bank is created by generating two or more P2H or P2H2 transactions that equally divide an amount of bitcoin into smaller values.  The size of the `<data>` for each one must be calculated such that the value it represents matches current block difficulty in number of hashes required to generate it through hashing.

This set of microtransactions acts as a bank that represents its total bitcoin value as a set of smaller proof of works equal to the bitcoin itself.  This bank can then be shared to peers and used as its own side-ledger independent of the blockchain, and only transacted with the blockchain as necessary and typically only after enough value has been exchanged to minimize transaction fees.

#### Proof of Work Difficulty

The value of every bitcoin is backed by the current [difficulty](https://en.bitcoin.it/wiki/Difficulty), which reduces to a number of hashes-per-satoshi ([example formula](http://bitcoin.stackexchange.com/questions/12013/how-many-hashes-create-one-bitcoin/12030#12030).  Currently, the difficulty of [40007470271.271](https://bitcoinwisdom.com/bitcoin/difficulty) results in approximately [65 hashes](https://www.google.com/#q=((270%2C591%2C326+*+60+*+10)+%2F+25)+%2F+100%2C000%2C000) to back the value of one satoshi.  A proof of work for one satoshi would then require between 6 and 7 bits, where a random bitstring of that size when hashed, would require an average of 65 hashes of the same size bitstring to find a match.

#### Private Penny Banks

> documentation here is a higher level work in progress and needs to be synchronized with the micropayment channel patterns

When Alice wants to perform a microtransaction with Bob, they begin by creating a new penny bank, a budget transaction that is high enough to avoid or minimize transaction fees, and then calculate the size of each microtransaction required and generate a P2HH for each one with the correct number of bits for the current difficulty.  The penny bank transaction contains all of the individual P2HH scripts (the pennies in the bank) and is generally very large and would be unfeasible to use as-is due to fees, but provides a guarantee to Bob that the value is budgeted.

Bob needs to verify the difficulty of the contained P2HH's, so picks one at random and challenges Alice to unlock it by sending the secret and validating that the bits in the secret match the current difficulty for each microtransaction (a partial/confidence-based [zero-knowledge proof](http://en.wikipedia.org/wiki/Zero-knowledge_proof) of the difficulty).  Once Bob is confident that the correct value is contained, they generate and send a penny bank transaction back to Alice that contains a direct P2PKH refund of most of the value, and the number of P2HH microtransactions for the value spent so far to lock the smaller value during the exchange.

As Alice and Bob exchange the actual small asset/values represented by a microtransaction, Bob continues to request a P2HH and Alice provides the secret.  At any point either side may request a re-balance, exchanging updated budget transactions with larger/smaller direct P2PKH's so that if either party leaves early, they can minimze the size that they will record with the network.

Need to expand yet on these points:

* provides a way to prove the budget is available and each P2HH unlocks that amount of value
* in the beginning the incentive is to cooperate since transaction fees would be too high to claim the small values
* since the brute force of a proof-of-work P2HH requires as many hashes as mining, there is no incentive to crack them
* if either side abandons the budget transaction, it can be held onto as an asset that will still increase in value
* the budget transactions can be easily combined with multi-key ones to add arbitration, locked to sidechains, include OP_RETURNs, etc

#### Public Penny Banks

> work in progress, brainstorming

Any bitcoin holder can create a public penny bank by turning a larger bitcoin value it into a number of small P2H transactions that anyone can claim.  These pennies can be registered with a trusted well-known penny banker, such that they can manage the transactions, but not claim the value themselves (without brute forcing).

When a microtransaction needs to be performed with any other peer that might be in isolation and never worth creating a private penny bank for, the two parties can negotiate which public penny bankers they both trust, and when finding a match then a microtransaction from that penny bank can be revealed to deliver that value.  The recipient then exchanges the secret with the penny banker to transfer it to their own, and either party can privately manage the larger penny bank transactions with the banker without having to ever record the small values on the main blockchain.
